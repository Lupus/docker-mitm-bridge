# Bug Report: Per-Pod Custom OPA Policy Annotation Fails for Deployment-Created Pods

## Summary

The per-pod custom OPA policy feature (via `intercept-proxy/opa-data` annotation) fails when pods are created by Deployments/ReplicaSets. The Kyverno mutation policy attempts to use `{{ request.object.metadata.name }}` to generate a ConfigMap name, but this field is not available for pods created via Deployments (where the name is generated dynamically by Kubernetes).

## Error Message

```
Error creating: admission webhook "mutate.kyverno.svc-fail" denied the request:
mutation policy intercept-proxy-inject-proxy error: failed to apply policy
intercept-proxy-inject-proxy rules [inject-volumes-custom-opa: variable
substitution failed: failed to resolve request.object.metadata.name at path
/mutate/patchStrategicMerge/spec/volumes/4/configMap/name: JMESPath query
failed: Unknown key "name" in path]
```

## Environment

- **Kubernetes**: Rancher Desktop with Cilium CNI
- **Kyverno**: Latest version
- **Chart Version**: Revision 4 (installed 2025-10-15 12:30:58)
- **Namespace**: kyverno-intercept (chart), graphiti-dev (target workload)

## Steps to Reproduce

1. Install the kyverno-intercept-chart:
```bash
helm install intercept-proxy ./kyverno-intercept-chart \
  --create-namespace -n kyverno-intercept
```

2. Create a Deployment with custom OPA annotation:
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dev-main
  namespace: graphiti-dev
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dev-main
  template:
    metadata:
      labels:
        app: dev-main
        intercept-proxy/enabled: "true"
      annotations:
        intercept-proxy/opa-data: |
          allowed_domains:
            - github.com
            - api.github.com
          unrestricted_domains:
            - api.anthropic.com
            - api.openai.com
            - mcp-router.graphiti-dev.svc.cluster.local
            - mcp-router
          github_read_access_enabled: true
          github_allowed_users: []
          github_allowed_repos:
            - Lupus/circuitry-cad
          aws_access_enabled: false
          aws_allowed_services: []
    spec:
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        runAsNonRoot: true
      containers:
      - name: dev-main
        image: dev-main:latest
        command: ["/bin/bash"]
        args: ["-c", "while true; do sleep 3600; done"]
```

3. Apply the deployment:
```bash
kubectl apply -f deployment.yaml
```

4. Observe the ReplicaSet events:
```bash
kubectl get events -n graphiti-dev | grep FailedCreate
```

## Expected Behavior

According to the README (lines 335-419), when a pod with the `intercept-proxy/opa-data` annotation is created:

1. Kyverno should automatically generate a unique ConfigMap named `{pod-name}-opa-policy`
2. The ConfigMap should contain:
   - The standard `policy.rego` rules from the chart
   - Custom `data.yml` from the annotation
3. The pod should be automatically configured to mount this per-pod ConfigMap
4. The pod should start successfully with the custom OPA policy

## Actual Behavior

1. The ReplicaSet attempts to create a pod
2. Kyverno mutation webhook intercepts the pod creation
3. The `inject-volumes-custom-opa` rule precondition matches (annotation exists)
4. The rule tries to use `{{ request.object.metadata.name }}` to create ConfigMap name
5. **This field doesn't exist** for pods created by Deployments (name is generated after admission)
6. Kyverno mutation fails with JMESPath error
7. Pod creation is blocked
8. ReplicaSet continuously fails to create pods

## Root Cause

In `templates/kyverno-policy.yaml`, the `inject-volumes-custom-opa` rule uses:

```yaml
- name: inject-volumes-custom-opa
  preconditions:
    all:
    - key: "{{ request.object.metadata.annotations.\"intercept-proxy/opa-data\" || '' }}"
      operator: NotEquals
      value: ""
  mutate:
    patchStrategicMerge:
      spec:
        volumes:
        - name: opa-policy
          configMap:
            name: "{{ request.object.metadata.name }}-opa-policy"  # ‚ùå THIS FAILS
```

**Problem**: For pods created by Deployments/ReplicaSets:
- `metadata.name` is NOT present in the admission request
- `metadata.generateName` contains the prefix (e.g., "dev-main-75cb69ff74-")
- The actual pod name is generated by Kubernetes AFTER admission

## Verification

```bash
# Check the deployed policy
kubectl get clusterpolicy intercept-proxy-inject-proxy -o jsonpath='{.spec.rules[?(@.name=="inject-volumes-custom-opa")].mutate.patchStrategicMerge.spec.volumes[4]}' | jq '.'

# Output:
{
  "configMap": {
    "name": "{{ request.object.metadata.name }}-opa-policy"
  },
  "name": "opa-policy"
}

# Check ReplicaSet status
kubectl get replicasets -n graphiti-dev -l app=dev-main
# Shows: DESIRED=1, CURRENT=0, READY=0 (pod creation blocked)

# Check events
kubectl get events -n graphiti-dev --sort-by='.lastTimestamp' | grep FailedCreate
# Shows the JMESPath error
```

## Impact

- **Severity**: High - Feature completely broken for Deployment-based workloads
- Users cannot use custom OPA policies for production workloads (Deployments)
- Only works for standalone Pods (not practical for production)
- Breaks the declarative GitOps workflow mentioned in README
- Blocks entire pod creation (pods never start)

## Proposed Solutions

### Option 1: Use Generate Policy Instead of Mutate (Recommended)

Create a separate Kyverno Generate policy that:
1. Triggers on Pod creation with the annotation
2. Uses `request.object.metadata.generateName` or generates a unique name
3. Creates the ConfigMap in a separate admission step
4. Let the mutation policy reference the predictably-named ConfigMap

Example:
```yaml
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: intercept-proxy-generate-opa-configmap
spec:
  rules:
  - name: generate-custom-opa-policy
    match:
      any:
      - resources:
          kinds:
          - Pod
          selector:
            matchLabels:
              intercept-proxy/enabled: "true"
    preconditions:
      all:
      - key: "{{ request.object.metadata.annotations.\"intercept-proxy/opa-data\" || '' }}"
        operator: NotEquals
        value: ""
    generate:
      apiVersion: v1
      kind: ConfigMap
      name: "{{ request.object.metadata.generateName }}{{ request.object.metadata.uid }}-opa-policy"
      namespace: "{{ request.namespace }}"
      synchronize: true
      data:
        data.yml: "{{ request.object.metadata.annotations.\"intercept-proxy/opa-data\" }}"
        policy.rego: "{{ configMap.intercept-proxy-opa-policy.policy.rego }}"
```

### Option 2: Use Labels Instead of Name-Based Reference

Instead of generating ConfigMaps per-pod, use:
1. Label-based selection for ConfigMaps
2. Generate ConfigMap with predictable labels matching the pod
3. Update volume mount to use label selector (if supported)

### Option 3: Use Owner References

1. Create ConfigMap with an init container or external controller
2. Set owner reference to the parent Deployment/ReplicaSet
3. Mutation policy looks up ConfigMap by owner reference

### Option 4: Document Limitation

If the feature is intended only for standalone Pods:
1. Update README to clearly state this limitation
2. Add precondition to skip Deployment-created pods:
```yaml
preconditions:
  all:
  - key: "{{ request.object.metadata.generateName || '' }}"
    operator: Equals
    value: ""  # Only match pods WITHOUT generateName (standalone pods)
```

## Workaround

Until this is fixed, users can:

1. **Remove the custom annotation** from Deployments
2. **Manually update the default ConfigMap** in each namespace:
```bash
kubectl edit configmap intercept-proxy-opa-policy -n graphiti-dev
# Add custom domains to unrestricted_domains
```

3. **Restart pods** to pick up the ConfigMap changes:
```bash
kubectl rollout restart deployment/dev-main -n graphiti-dev
```

This loses the per-pod customization benefit but unblocks pod creation.

## Related Documentation

- **README.md lines 335-419**: Per-Pod Custom OPA Policies section
- **README.md lines 381-399**: "Updating Policies" section (mentions Deployment workflows)
- **templates/kyverno-policy.yaml**: inject-volumes-custom-opa rule

## Test Case

A test case should be added to verify this works with Deployments:

```yaml
# tests/deployment-with-custom-opa.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-deployment-custom-opa
  namespace: kyverno-intercept
spec:
  replicas: 1
  selector:
    matchLabels:
      app: test-custom-opa
  template:
    metadata:
      labels:
        app: test-custom-opa
        intercept-proxy/enabled: "true"
      annotations:
        intercept-proxy/opa-data: |
          unrestricted_domains:
            - "test.example.com"
    spec:
      securityContext:
        runAsUser: 12345
      containers:
      - name: test
        image: nicolaka/netshoot:latest
        command: ["sleep", "3600"]
```

Expected: Pod should start successfully with custom policy
Actual: Pod creation fails with JMESPath error

## Additional Context

This issue was discovered when attempting to add `mcp-router` domains to the OPA policy for a development environment deployed via DevSpace. The deployment was previously working with the default cloned ConfigMaps, but after attempting to use the per-pod custom annotation feature (as documented in README), all pod creation was blocked.

The feature works correctly in the README examples because they all show standalone Pods, not Deployments.
